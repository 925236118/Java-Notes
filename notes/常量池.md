# Java常量池理解及总结

## 1、相关概念

Java中的常量池，实际上分为两种形态：**静态常量池** 和**运行时常量池** 。

### 1.1 静态常量池

在Class文件结构中，最头的4个字节用于存储魔数Magic Number(OxCAFEBABE)，用于确定一个文件是否能被JVM接受；再接着4个字节用于存储版本号，前2个字节存储次版本号，后2个存储主版本号；再接着是用于存放常量的常量池，由于常量的数量是不固定的，所以常量池的入口放置一个U2类型的数据(constant_pool_count)存储常量池容量计数值。这部分常量池称为静态常量池。

Class常量池中主要存放两大类常量：字面量(Literal)和符号引用(Symbolic References)，字面量比较接近于Java语言层面的常量概念，如文本字符串、被声明为final的常量值等，而符号引用则属于编译原理方面的概念。Class常量将在类加载后进入方法区的运行时常量池中存放（稍后讲解）。其中，符号引用主要包括下面几类常量：

- 被模块导出或者开放的包(Package)
- 类和接口的全限定名(Fully Qualified Name)
- 字段的名称和描述符(Descriptor)
- 方法的名称和描述符
- 方法的句柄和方法类型(Method Handle、Method Type、Invoke Dynamic)
- 动态调用点和动态常量(Dynamically-Computed Call Site、Dynamically-Computed Constant)

常量池中每一项常量都是一个表，共有17种不同类型的表。它们共有一个特定，表结构起始的第一位是个u1类型的标志位(tag，用于区分常量类型)，代表着当前常量属于哪种常量类型。17种常量类型所代表的具体含义如下表所示。
| 类  型 | 标  志 | 描  述 |
| :-----| :----: | :----: |
| CONSTANT_Utf8_info | 1 | UTF-8编码的字符串 |
| CONSTANT_Integer_info | 3 | 整型字面量 |
| CONSTANT_Float_info | 4 | 浮点型字面量 |
| CONSTANT_Long_info | 5 | 长整型字面量 |
| CONSTANT_Double_info | 6 | 双精度浮点型字面量 |
| CONSTANT_Class_info | 7 | 类或接口的符号引用 |
| CONSTANT_String_info | 8 | 字符串类型字面量 |
| CONSTANT_Fieldref_info | 9 | 字段的符号引用 |
| CONSTANT_Methodref_info | 10 | 类中方法的符号引用 |
| CONSTANT_InterfaceMethodref_info | 11 | 接口中方法的符号引用 |
| CONSTANT_NameAndType_info | 12 | 字段或方法的部分符号引用 |
| CONSTANT_MethodHandle_info | 15 | 表示方法句柄 |
| CONSTANT_MethodType_info | 16 | 表示方法类型 |
| CONSTANT_Dynamic_info | 17 | 表示一个动态计算常量 |
| CONSTANT_InvokeDynamic_info | 18 | 表示一个动态方法调用点 |
| CONSTANT_Module_info | 19 | 表示一个模块 |
| CONSTANT_Package_info | 20 | 表示一个模块中开放或者导出的包 |

以简单的Java代码为例：

```java
//Java代码
public static void main(String[] args) {
    String str="zingbug";//
}
//编译后的ByteCode字节码和部分常量池
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = String             #8             // zingbug
   #8 = Utf8               zingbug
   #9 = Class              #10            // Main
  #10 = Utf8               Main
  ...
```

### 1.2 运行时常量池

一个类加载到JVM中后对应一个运行时常量池。运行时常量池，是指jvm虚拟机在完成类装载操作后，将class文件中的常量池载入到内存中，并保存在方法区中，我们常说的常量池，就是指方法区中的运行时常量池。这其中涉及到类加载的解析阶段。

虚拟机类加载过程的解析阶段是Java虚拟机将常量池内的符号引用替换为直接引用的过程，符号引用在Class文件中以CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info等类型的常量出现，符号引用和直接引用的区别在于：

- 符号引用是以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只用使用时能无歧义地定位到目标即可，与当前虚拟机实现的内存布局无关。
- 直接引用是可以直接指向目标的指针、相对偏移量或者是一个能间接定位到目标的句柄。直接引用和虚拟机实现的内存布局直接相关的，同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那么引用的目标必定已经在虚拟机的内存中存在。

运行时常量池相对于CLass文件常量池的另外一个重要特征是**具备动态性**，Class文件常量只是一个静态存储结构，里面的引用都是符号引用。而运行时常量池可以在运行期间将符号引用解析为直接引用。可以说运行时常量池就是用来索引和查找字段和方法名称和描述符的。给定任意一个方法或字段的索引，通过这个索引最终可得到该方法或字段所属的类型信息和名称及描述符信息，这涉及到方法的调用和字段获取。

Java语言并不要求常量一定只有编译期才能产生，也就是并非预置入CLass文件中常量池的内容才能进入方法区运行时常量池，运行期间也可能将新的常量放入池中，这种特性被开发人员利用比较多的就是String类的intern()方法。

> String的intern()方法会查找在常量池中是否存在一份equal相等的字符串,如果有则返回该字符串的引用,如果没有则添加自己的字符串进入常量池。

私认为，**运行时常量池是class文件常量池在运行时的表示。**

我们都知道运行时常量池是放在方法区的，但需要注意的是，方法区本身就是一个逻辑性的区域。在JDK7及之前，HotSpot使用永久代来实现方法区时，实现是完全符合这种逻辑概念的；但在JDK8及以后，取消了永久代，新增了元空间(Metaspace)，方法区就“四分五裂了”，不再是在单一的一个去区域内进行存储，其中，元空间只存储类和类加载器的元数据信息，符号引用存储在native heap中，字符串常量和静态类型变量存储在普通的堆区中，这时候方法区只是对逻辑概念的表述罢了。

### 1.3 常量池的优势


参考资料：

《Java核心技术系列：Java虚拟机规范（Java SE 8版）》  
《深入理解Java虚拟机：JVM高级特性与最佳实践（第3版）》  
[深入浅出java常量池](https://www.cnblogs.com/syp172654682/p/8082625.html)  
[Java常量池理解与总结](https://mp.weixin.qq.com/s?__biz=MzU3NDg0MTY0NQ==&mid=2247485452&idx=1&sn=64178cb2b4e2768b2feedbe0d0971ee1&chksm=fd2d7e4eca5af7587be00fccbec403117cdb7eb681c0542ff542335b1239049bd0216fc1bb1d&mpshare=1&scene=1&srcid=0623b0MIhBaU2sZEhvxEjoME&sharer_sharetime=1592875293438&sharer_shareid=e9e6d524172161e8393308ae6db3aa63&key=242af3e89b1070825a226d604188d71bc5c856baa07c40c96c01389ddc232167ec2a8196658f02f540cce13a26664b46549909f0156708f4d7d26fc7c470faeb92a6c0d4f3ad7328a7cbe59a5c3a0cd6&ascene=1&uin=MjQ3MzkwMTc2Mw%3D%3D&devicetype=Windows+10+x64&version=62090523&lang=zh_CN&exportkey=AVRh0T9RxdKUe0T%2BS0Vu7Jk%3D&pass_ticket=mrrMmVKWvl4QF8i0mBVDO7Xre7kYXlm7qLoXUV%2FJeUsPvRILMjcMWMW1A%2BzBALMH)

ZingBug，2020/6/26
[EOF]
